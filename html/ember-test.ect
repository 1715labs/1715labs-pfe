<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <title>Ember test</title>
    <script src="/bower_components/jquery/dist/jquery.js"></script>
    <script src="/bower_components/handlebars/handlebars.js"></script>
    <script src="/bower_components/ember/ember.js"></script>
  </head>

  <body>
    <script type="text/x-handlebars" data-template-name="application">
      <header>Zooniverse</header>
      <hr />
      {{outlet}}
      <hr />
      <footer>Privacy | Contact</footer>
    </script>

    <script type="text/x-handlebars" data-template-name="index">
      {{#link-to 'projects'}}Projects{{/link-to}}
    </script>

    <script type="text/x-handlebars" data-template-name="projects">
      Projects!
      <ul>
        {{#each}}
          <li>{{owner}}/{{name}} ({{path}})</li>
        {{/each}}
      </ul>
    </script>

    <script type="text/x-handlebars" data-template-name="project">
      <div>{{owner}}/{{name}}</div>
      <div>{{description}}</div>
    </script>

    <script>

      var App = window.App = Ember.Application.create();
      var store = window.store = {};

      App.Model = Ember.Object.extend({
        init: function() {
          store[this.constructor.type] = store[this.constructor.type] || {};
          store[this.constructor.type][this.id] = this;
          console.log('Create', this);
        }
      });

      App.Owner = App.Model.extend({
        name: ''
      });

      App.Owner.type = 'owners';

      App.Project = App.Model.extend({
        name: '(Unnamed project)',

        description: '(No description)',

        _owner: function() {
          return store.owners[this.get('owner')];
        }.property('owner'),

        path: function() {
          return this.get('_owner').name + '/' + this.name;
        }.property('_owner', 'name')
      });

      App.Project.type = 'projects';

      App.Router.map(function() {
        this.route('projects');
      });

      App.ProjectsRoute = Ember.Route.extend({
        model: function() {
          var request = new $.Deferred

          setTimeout(function() {
            request.resolve({
              owners: [{
                id: '0',
                name: 'Zooniverse'
              }],
              projects: [{
                id: '1',
                owner: '0',
                name: 'Galaxy Zoo',
                description: 'Help explore the universe'
              }, {
                id: '2',
                owner: '0',
                name: 'Planet Hunters',
                description: 'Help explore other stars'
              }, {
                id: '3',
                owner: '0',
                name: 'The Milky Way Project',
                description: 'Help explore the galaxy'
              }]
            });
          }, 250);

          return request.then(function(data) {
            data.owners.forEach(function(owner) {
              App.Owner.create(owner);
            });

            return data.projects.map(function(project) {
              return App.Project.create(project);
            });
          });
        }
      });
    </script>
  </body>
</html>
